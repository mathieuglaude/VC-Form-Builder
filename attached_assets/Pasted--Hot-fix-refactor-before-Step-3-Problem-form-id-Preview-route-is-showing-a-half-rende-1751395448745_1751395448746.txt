üéØ Hot-fix + refactor before Step 3  

Problem  
‚ñ™ /form/:id ‚ÄúPreview‚Äù route is showing a half-rendered QR it shouldn‚Äôt.  
‚ñ™ /launch/:id and /f/:slug don‚Äôt always show the QR at all.  
Root cause: proof-initialisation + QR fetch logic duplicated / missing between pages, and `VerificationPanel` mounted in Preview by mistake.  

Tasks (one commit)  

1Ô∏è‚É£ Unify proof initialisation  
   ‚Ä¢ create **/web/hooks/useProofRequest.ts**  
     ```ts
     interface UseProofRequestOpts { formId?: string; publicSlug?: string; enabled?: boolean; }
     export function useProofRequest({formId, publicSlug, enabled=true}:UseProofRequestOpts){
       // uses react-query; key ['proof',formId||publicSlug]
       // POST /api/proofs/init  body {formId} or {publicSlug}
       // returns {proofId}  -> state {proofId, isLoading, error}
     }
     ```  
   ‚Ä¢ remove any inline `/api/proofs/init` fetches and replace with hook in **FormLaunchPage.tsx** and **PublicFormPage.tsx**.  
   ‚Ä¢ Don‚Äôt call the hook in **FormPage** (Preview).

2Ô∏è‚É£ Hide panel in Preview  
   ‚Ä¢ Builder sends users to preview with `?preview=1` (link is already there ‚Äì if not, add).  
   ‚Ä¢ Inside **FormPage.tsx** read `const isPreview = new URLSearchParams(location.search).has('preview');`  
     ‚Üí render the form only. No VerificationPanel, no ‚ÄúVerify Credentials‚Äù button.

3Ô∏è‚É£ Always show panel in Launch & Public flows  
   ‚Ä¢ In both pages:  
     ```tsx
     const {proofId,isLoading:proofLoading} = useProofRequest({formId, publicSlug});
     const hasVC = formHasVCFields(form);   // existing helper
     const showPanel = hasVC && proofId;
     ```  
   ‚Ä¢ If `hasVC && proofLoading` ‚Üí show small spinner placeholder same size as panel.  
   ‚Ä¢ On `showPanel`, mount `<VerificationPanel proofId={proofId} />` (already built in Step-2).

4Ô∏è‚É£ Fix QR `<img>`  
   ‚Ä¢ In **VerificationPanel.tsx** after you fetch `/api/proofs/${proofId}/qr` the API returns `{svg, invitationUrl}` ‚Äì we only sent `svg` before.  
   ‚Ä¢ Update backend route `GET /api/proofs/:id/qr` to respond  
     ```json
     { "svg": "<svg‚Ä¶>", "invitationUrl": "https://‚Ä¶" }
     ```  
   ‚Ä¢ Panel does  
     ```tsx
     <img width={250} height={250}
          src={`data:image/svg+xml;utf8,${encodeURIComponent(data.svg)}`}
          alt="Credential verification QR" />
     ```  

5Ô∏è‚É£ Smoke-tests (you can run):  
   ‚òê **Preview** (/form/ID?preview=1) ‚Äì shows form only, no QR.  
   ‚òê **Launch** (/launch/ID) ‚Äì shows QR after short spinner.  
   ‚òê **Public** (/f/SLUG) ‚Äì identical behaviour to Launch.  
   ‚òê Clicking ‚ÄúOpen in Wallet‚Äù opens `invitationUrl`.  
   ‚òê Network tab shows exactly one call to `/api/proofs/:id/qr` (cache working).

6Ô∏è‚É£ Update *replit.md*  
2025-07-01
Hot-fix: VerificationPanel hidden in Preview, standardised between Launch/Public

Added useProofRequest hook ‚Üí no duplicate code

/api/proofs/:id/qr now returns {svg, invitationUrl}

arduino
Copy
Edit
