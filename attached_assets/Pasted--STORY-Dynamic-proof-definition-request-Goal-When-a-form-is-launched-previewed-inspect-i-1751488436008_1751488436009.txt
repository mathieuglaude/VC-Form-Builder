### ğŸŸ¢  STORY: Dynamic proof definition + request
Goal: When a form is launched/previewed, inspect its VC-field mappings and
automatically build a **Define-Proof-Request** + **Prepare-URL** call to
Orbit so the QR represents exactly the attributes that form requires.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1.  Refactor mappingExtractor
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ expose 2 pure helpers in  packages/shared/src/proof:
  â”œâ”€ extractMappings(formSchema)  ->  Array<{credType, attrName}>
  â””â”€ buildDefinePayload(mappings) ->  Orbit request body
â€¢ For each mapping:
  â€¢ requestedAttributes[i] =
    {
      "name": attrName,
      "restrictions": [
        {
          "anoncredsCredDefId": CRED_MAP[credType].credDefId,
          "anoncredsIssuerDid": CRED_MAP[credType].issuerDid,
          "anoncredsSchemaName": CRED_MAP[credType].schemaName,
          "anoncredsSchemaVersion": CRED_MAP[credType].schemaVersion,
          "anoncredsSchemaId": CRED_MAP[credType].schemaId
        }
      ]
    }
â€¢ If form has no VC fields â†’ return null (backend responds 204).

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2.  Orchestrator (/api/proofs/init-form/:id)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Replace ad-hoc â€œhard-coded attributeâ€ logic with new helpers.
â€¢ Flow:
  a. get form
  b. extractMappings â†’ if empty => {status:'no-vc'} (HTTP 200)
  c. define-proof-request (POST)  -> proofDefineId
  d. prepare URL   (POST)         -> {shortUrl, svg}
  e. response 200 {svg, invitationUrl, proofId, status:'orbit'}

â€¢ Keep existing fallback QR path if any Orbit step fails.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
3.  Front-end
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ No changes needed: hook already consumes {svg, invitationUrl}.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
4.  Tests (must be updated **every push**)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ§ª unit
  â€¢ packages/shared/__tests__/mappingExtractor.test.ts
    â€“ given form fixture with 1-N VC fields returns correct array & payload
  â€¢ packages/shared/__tests__/buildDefinePayload.test.ts
    â€“ snapshot of full Orbit body

ğŸ§ª e2e (playwright or cypress)
  â€¢ tests/e2e/proofFlow.e2e.ts  
    â€“ create form fixture with birthdate_dateint attribute  
    â€“ open `/form/{id}?preview=1`  
    â€“ assert panel visible & QR `<img src="data:image/svg+xmlâ€¦">` exists  
    â€“ assert network POST `/api/proofs/init-form/{id}` returns 200 & body.status==='orbit'

Run: `pnpm vitest && pnpm playwright test`  â†’ all green.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
5.  CI rule
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
If vitest or e2e suite fails, abort commit and show failing diff.
Add note to replit.md.

Commit message:
feat: dynamic Orbit proof payload per form mapping
test: add unit & e2e coverage for extractor + QR flow

pgsql
Copy
Edit

###  ğŸ”  Remember  
*After* implementing each task, create/extend tests **before** committing.  
No new feature is â€œdoneâ€ until its tests pass and prior tests remain green.
How to verify quickly

Edit any form and map a VC attribute (e.g., Unverified Person â†’ birthdate_dateint).

Visit /form/{id}?preview=1 â†’ panel auto-opens, QR appears.

Console network tab:
â€¢ POST /api/proofs/init-form/{id} 200
â€¢ body.requestedAttributes[0].name === "birthdate_dateint"

Scan QR with BC Wallet â€“ it should prompt for Unverified Person credential.

